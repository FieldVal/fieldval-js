"use strict";function FieldVal(r){var e=this;e.validating=r,e.missing_keys={},e.missing_count=0,e.invalid_keys={},e.invalid_count=0,e.unrecognized_keys={},e.unrecognized_count=0,e.recognized_keys={},e.errors=[]}var logger;"function"==typeof require&&(logger=require("tracer").console()),Array.isArray||(Array.isArray=function(r){return"[object Array]"===Object.prototype.toString.call(r)}),FieldVal.INCORRECT_TYPE_ERROR=function(r,e){return{error_message:"Incorrect field type. Expected "+r+".",error:FieldVal.INCORRECT_FIELD_TYPE,expected:r,received:e}},FieldVal.MISSING_ERROR=function(){return{error_message:"Field missing.",error:FieldVal.FIELD_MISSING}},FieldVal.REQUIRED_ERROR={},FieldVal.NOT_REQUIRED_BUT_MISSING={},FieldVal.ONE_OR_MORE_ERRORS=0,FieldVal.FIELD_MISSING=1,FieldVal.INCORRECT_FIELD_TYPE=2,FieldVal.FIELD_UNRECOGNIZED=3,FieldVal.MULTIPLE_ERRORS=4,FieldVal.get_value_and_type=function(r,e,i){i||(i={});var n=void 0!==i.parse?i.parse:!1;if("string"!=typeof r||n)if("integer"===e){var o=parseInt(r,10);isNaN(o)||o.toString().length!==r.toString().length||(r=o,e=o,e="number")}else if("float"===e){var t=parseFloat(r,10);isNaN(t)||(r=t,e="number")}var l=typeof r;return"object"===l&&"[object Array]"===Object.prototype.toString.call(r)&&(l="array"),{type:l,desired_type:e,value:r}},FieldVal.use_checks=function(r,e,i,n,o){var t,l=!1,a=!1;i||(t=new FieldVal);var s,d,u=!1,c=function(e){var o,s,d=!0,_={};if("object"==typeof e){if(Array.isArray(e)){for(s=0;s<e.length&&(c(e[s]),!a);s++);return}_=e,o=_.check,null!==_&&void 0!==_.stop_on_error&&(d=_.stop_on_error)}else o=e,d=!0;var g=o(r,function(e){r=e});if(null!==g&&void 0!==g){if(g===FieldVal.REQUIRED_ERROR)if(n){if(!i)return g;i.missing(n,_)}else{if(!i)return void(u=!0);i.error(FieldVal.create_error(FieldVal.MISSING_ERROR,_))}else g!==FieldVal.NOT_REQUIRED_BUT_MISSING&&(i?n?i.invalid(n,g):i.error(g):t.error(g));l=!0,d&&(a=!0)}};for(s=0;s<e.length;s++){if(d=e[s],c(d),u)return FieldVal.REQUIRED_ERROR;if(a)break}return l?o&&o(void 0):o&&o(r),i?void 0:t.end()},FieldVal.required=function(r,e){var i=function(e){return null===e||void 0===e?r||void 0===r?FieldVal.REQUIRED_ERROR:FieldVal.NOT_REQUIRED_BUT_MISSING:void 0};return void 0!==e?(e.check=i,e):i},FieldVal.type=function(r,e){var i=void 0!==e.required?e.required:!0,n=function(n,o){var t=FieldVal.required(i)(n);if(t)return t;var l=FieldVal.get_value_and_type(n,r,e),a=l.desired_type,s=l.type;return n=l.value,s!==a?FieldVal.create_error(FieldVal.INCORRECT_TYPE_ERROR,e,a,s):void(o&&o(n))};return void 0!==e?(e.check=n,e):n},FieldVal.prototype.default=function(r){var e=this;return{get:function(){var i=e.get.apply(e,arguments);return void 0!==i?i:r}}},FieldVal.prototype.get=function(r){var e=this,i=e.validating[r];if(e.recognized_keys[r]=!0,arguments.length>1){var n=Array.prototype.slice.call(arguments,1);FieldVal.use_checks(i,n,e,r,function(r){i=r})}return i},FieldVal.prototype.error=function(r){var e=this;return e.errors.push(r),e},FieldVal.prototype.invalid=function(r,e){var i=this,n=i.invalid_keys[r];return void 0!==n?void 0!==n.errors?n.errors.push(e):i.invalid_keys[r]={error:FieldVal.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:[n,e]}:(i.invalid_keys[r]=e,i.invalid_count++),i},FieldVal.prototype.missing=function(r,e){var i=this;return i.missing_keys[r]=FieldVal.create_error(FieldVal.MISSING_ERROR,e),i.missing_count++,i},FieldVal.prototype.unrecognized=function(r){var e=this;return e.unrecognized_keys[r]={error_message:"Unrecognized field.",error:FieldVal.FIELD_UNRECOGNIZED},e.unrecognized_count++,e},FieldVal.prototype.recognized=function(r){var e=this;return e.recognized_keys[r]=!0,e},FieldVal.prototype.get_unrecognized=function(){var r,e=this,i=[];for(r in e.validating)e.validating.hasOwnProperty(r)&&e.recognized_keys[r]!==!0&&i.push(r);return i},FieldVal.prototype.end=function(){var r,e=this,i={},n=!1,o={},t=0;for(r in e.unrecognized)e.unrecognized.hasOwnProperty(r)&&(o[r]=e.unrecognized[r],t++);var l,a,s=e.get_unrecognized();for(l=0;l<s.length;l++)a=s[l],o[a]||(o[a]={error_message:"Unrecognized field.",error:FieldVal.FIELD_UNRECOGNIZED},t++);if(0!==e.missing_count&&(i.missing=e.missing_keys,n=!0),0!==e.invalid_count&&(i.invalid=e.invalid_keys,n=!0),0!==t&&(i.unrecognized=o,n=!0),n){if(i.error_message="One or more errors.",i.error=FieldVal.ONE_OR_MORE_ERRORS,0===e.errors.length)return i;e.errors.push(i)}return 0!==e.errors.length?1===e.errors.length?e.errors[0]:{error:FieldVal.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:e.errors}:null},FieldVal.create_error=function(r,e){if(!e)return r.apply(null,Array.prototype.slice.call(arguments,2));if(r===FieldVal.MISSING_ERROR){if("function"==typeof e.missing_error)return e.missing_error.apply(null,Array.prototype.slice.call(arguments,2));if("object"==typeof e.missing_error)return e.missing_error;if("string"==typeof e.missing_error)return{error_message:e.missing_error}}else{if("function"==typeof e.error)return e.error.apply(null,Array.prototype.slice.call(arguments,2));if("object"==typeof e.error)return e.error;if("string"==typeof e.error)return{error_message:e.error}}return r.apply(null,Array.prototype.slice.call(arguments,2))},FieldVal.Error=function(r,e,i){if("object"==typeof r&&"[object Array]"===Object.prototype.toString.call(r)){var n=r;r=n[0],e=n[1],i=n[2]}var o={error:r};return void 0!==e&&null!==e&&(o.error_message=e),void 0!==i&&null!==i&&(o.data=i),o},void 0!==module&&(module.exports=FieldVal);