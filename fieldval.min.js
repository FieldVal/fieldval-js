"use strict";function FieldVal(e){var r=this;r.async_waiting=0,r.validating=e,r.missing_keys={},r.missing_count=0,r.invalid_keys={},r.invalid_count=0,r.unrecognized_keys={},r.unrecognized_count=0,r.recognized_keys={},r.errors=[]}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),FieldVal.INCORRECT_TYPE_ERROR=function(e,r){return{error_message:"Incorrect field type. Expected "+e+".",error:FieldVal.INCORRECT_FIELD_TYPE,expected:e,received:r}},FieldVal.MISSING_ERROR=function(){return{error_message:"Field missing.",error:FieldVal.FIELD_MISSING}},FieldVal.ASYNC=-1,FieldVal.REQUIRED_ERROR=Math.sqrt,FieldVal.NOT_REQUIRED_BUT_MISSING=Math.floor,FieldVal.ONE_OR_MORE_ERRORS=0,FieldVal.FIELD_MISSING=1,FieldVal.INCORRECT_FIELD_TYPE=2,FieldVal.FIELD_UNRECOGNIZED=3,FieldVal.MULTIPLE_ERRORS=4,FieldVal.get_value_and_type=function(e,r,i){i||(i={});var n=void 0!==i.parse?i.parse:!1;if("string"!=typeof e||n)if("integer"===r){var t=parseInt(e,10);isNaN(t)||t.toString().length!==e.toString().length||(e=t,r=t,r="number")}else if("float"===r||"number"===r){var a=parseFloat(e,10);isNaN(a)||a.toString().length!==e.toString().length||(e=a,r="number")}var o=typeof e;return"object"===o&&Array.isArray(e)&&(o="array"),{type:o,desired_type:r,value:e}},FieldVal.use_check=function(e,r,i){var n,t=!0,a={},o=0;if("object"==typeof e){if(Array.isArray(e)){var l=e,s=function(){return o++,r.stop||o>l.length?void i():void FieldVal.use_check(l[o-1],r,function(){s()})};return void s()}a=e,n=a.check,null!==a&&void 0!==a.stop_on_error&&(t=a.stop_on_error)}else{if("function"!=typeof e)throw new Error("A check can only be provided as a function or as an object with a function as the .check property.");n=e,t=!0}var d=function(e){if(null!==e&&void 0!==e){if(t&&(r.stop=!0),r.had_error=!0,e===FieldVal.REQUIRED_ERROR)return r.field_name?(r.validator.missing(r.field_name,a),void i()):r.existing_validator?(r.validator.error(FieldVal.create_error(FieldVal.MISSING_ERROR,a)),void i()):(r.return_missing=!0,void i());e!==FieldVal.NOT_REQUIRED_BUT_MISSING&&(r.existing_validator?(r.field_name?r.validator.invalid(r.field_name,e):r.validator.error(e),i()):(r.validator.error(e),i()))}else i()},u=n(r.value,r.emit,function(e){d(e)});u===FieldVal.ASYNC||d(u)},FieldVal.use_checks=function(e,r,i,n,t,a){var o={value:e,field_name:n,emit:function(e){o.value=e},external_emit:t,stop:!1,return_missing:!1,had_error:!1};i?(o.validator=i,o.existing_validator=!0):o.validator=new FieldVal;var l=void 0,s=function(e){l=e};o.validator.async_waiting++;FieldVal.use_check(r||[],o,function(){return o.had_error?o.external_emit&&o.external_emit(void 0):o.external_emit&&o.external_emit(o.value),o.return_missing?void s(FieldVal.REQUIRED_ERROR):o.existing_validator?void o.validator.async_call_ended():void s(o.validator.end())});return void 0!==l?l:void(s=a)},FieldVal.required=function(e,r){var i=function(r){return null===r||void 0===r?e||void 0===e?FieldVal.REQUIRED_ERROR:FieldVal.NOT_REQUIRED_BUT_MISSING:void 0};return void 0!==r?(r.check=i,r):i},FieldVal.type=function(e,r){var i=r&&void 0!==r.required?r.required:!0,n=function(n,t){var a=FieldVal.required(i)(n);if(a)return a;var o=FieldVal.get_value_and_type(n,e,r),l=o.desired_type,s=o.type;return n=o.value,s!==l?FieldVal.create_error(FieldVal.INCORRECT_TYPE_ERROR,r,l,s):void(t&&t(n))};return void 0!==r?(r.check=n,r):n},FieldVal.prototype.default_value=function(e){var r=this;return{get:function(){var i=r.get.apply(r,arguments);return void 0!==i?i:e}}},FieldVal.prototype.get=function(e){var r=this,i=r.validating[e];if(r.recognized_keys[e]=!0,arguments.length>1){var n=Array.prototype.slice.call(arguments,1);FieldVal.use_checks(i,n,r,e,function(e){i=e})}return i},FieldVal.prototype.error=function(e){var r=this;return r.errors.push(e),r},FieldVal.prototype.invalid=function(e,r){var i=this,n=i.invalid_keys[e];return void 0!==n?void 0!==n.errors?n.errors.push(r):i.invalid_keys[e]={error:FieldVal.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:[n,r]}:(i.invalid_keys[e]=r,i.invalid_count++),i},FieldVal.prototype.missing=function(e,r){var i=this;return i.missing_keys[e]=FieldVal.create_error(FieldVal.MISSING_ERROR,r),i.missing_count++,i},FieldVal.prototype.unrecognized=function(e){var r=this;return r.unrecognized_keys[e]={error_message:"Unrecognized field.",error:FieldVal.FIELD_UNRECOGNIZED},r.unrecognized_count++,r},FieldVal.prototype.recognized=function(e){var r=this;return r.recognized_keys[e]=!0,r},FieldVal.prototype.get_unrecognized=function(){var e,r=this,i=[];for(e in r.validating)r.validating.hasOwnProperty(e)&&r.recognized_keys[e]!==!0&&i.push(e);return i},FieldVal.prototype.async_call_ended=function(){var e=this;e.async_waiting--,e.async_waiting<=0&&e.end_callback&&e.end_callback(e.generate_response())},FieldVal.prototype.generate_response=function(){var e,r=this,i={},n=!1,t={},a=0;for(e in r.unrecognized_keys)r.unrecognized_keys.hasOwnProperty(e)&&(t[e]=r.unrecognized_keys[e],a++);var o,l,s=r.get_unrecognized();for(o=0;o<s.length;o++)l=s[o],t[l]||(t[l]={error_message:"Unrecognized field.",error:FieldVal.FIELD_UNRECOGNIZED},a++);if(0!==r.missing_count&&(i.missing=r.missing_keys,n=!0),0!==r.invalid_count&&(i.invalid=r.invalid_keys,n=!0),0!==a&&(i.unrecognized=t,n=!0),n){if(i.error_message="One or more errors.",i.error=FieldVal.ONE_OR_MORE_ERRORS,0===r.errors.length)return i;r.errors.push(i)}return 0!==r.errors.length?1===r.errors.length?r.errors[0]:{error:FieldVal.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:r.errors}:null},FieldVal.prototype.end=function(e){var r=this;return e?(r.end_callback=e,void(r.async_waiting<=0&&e(r.generate_response()))):r.generate_response()},FieldVal.create_error=function(e,r){if(!r)return e.apply(null,Array.prototype.slice.call(arguments,2));if(e===FieldVal.MISSING_ERROR){var i=typeof r.missing_error;if("function"===i)return r.missing_error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===i)return r.missing_error;if("string"===i)return{error_message:r.missing_error}}else{var n=typeof r.error;if("function"===n)return r.error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===n)return r.error;if("string"===n)return{error_message:r.error}}return e.apply(null,Array.prototype.slice.call(arguments,2))},"undefined"!=typeof module&&(module.exports=FieldVal);