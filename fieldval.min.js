var FieldVal=function(){"use strict";function r(e,i,t){var o=this;if(o.async_waiting=0,o.validating=e,o.missing_keys={},o.missing_count=0,o.invalid_keys={},o.invalid_count=0,o.unrecognized_keys={},o.unrecognized_count=0,o.recognized_keys=t||{},o.errors=[],i){var a;if(i.error===r.ONE_OR_MORE_ERRORS)a=i;else if(i.error===r.MULTIPLE_ERRORS)for(var s=0;s<i.errors.length;s++){var u=i.errors[s];0!==u.error?o.errors.push(u):a=u}else o.errors.push(i);a&&(a.missing&&(o.missing_keys=a.missing,o.missing_count=n(o.missing_keys)),a.unrecognized&&(o.unrecognized_keys=a.unrecognized,o.unrecognized_count=n(o.unrecognized_keys)),a.invalid&&(o.invalid_keys=a.invalid,o.invalid_count=n(o.invalid_count)))}}var e;"function"==typeof require&&(e=require("tracer").console()),Array.isArray||(Array.isArray=function(r){return"[object Array]"===Object.prototype.toString.call(r)});var n=function(r){var e,n=0;for(e in r)r.hasOwnProperty(e)&&n++;return n};return r.prototype.default_value=function(r){var e=this;return{get:function(){var n=e.get.apply(e,arguments);return void 0!==n?n:r}}},r.prototype.get=function(e){var n,i=this,t=Array.prototype.slice.call(arguments,1),o=!1,a=i.get_async(e,t,function(r){o=!0,n=r});if(a===r.ASYNC)throw new Error(".get used with async checks, use .get_async.");return n},r.prototype.get_async=function(e,n,i){var t=this,o=t.validating[e];t.recognized_keys[e]=!0;var a=r.use_checks(o,n,{validator:t,field_name:e,emit:function(r){o=r}},function(){i(o)});return a===r.ASYNC?r.ASYNC:void 0},r.prototype.error=function(r){var e=this;return e.errors.push(r),e},r.prototype.invalid=function(e,n){var i=this,t=i.invalid_keys[e];return void 0!==t?void 0!==t.errors?t.errors.push(n):i.invalid_keys[e]={error:r.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:[t,n]}:(i.invalid_keys[e]=n,i.invalid_count++),i},r.prototype.missing=function(e,n){var i=this;return i.missing_keys[e]=r.create_error(r.MISSING_ERROR,n),i.missing_count++,i},r.prototype.unrecognized=function(e){var n=this;return n.unrecognized_keys[e]={error_message:"Unrecognized field.",error:r.FIELD_UNRECOGNIZED},n.unrecognized_count++,n},r.prototype.recognized=function(r){var e=this;return e.recognized_keys[r]=!0,e},r.prototype.get_unrecognized=function(){var r,e=this,n=[];for(r in e.validating)e.validating.hasOwnProperty(r)&&e.recognized_keys[r]!==!0&&n.push(r);return n},r.prototype.async_call_ended=function(){var r=this;r.async_waiting--,r.async_waiting<=0&&r.end_callback&&r.end_callback(r.generate_response(),r.recognized_keys)},r.prototype.generate_response=function(){var e,n=this,i={},t=!1,o={},a=0;for(e in n.unrecognized_keys)n.unrecognized_keys.hasOwnProperty(e)&&(o[e]=n.unrecognized_keys[e],a++);var s,u,c=n.get_unrecognized();for(s=0;s<c.length;s++)u=c[s],o[u]||(o[u]={error_message:"Unrecognized field.",error:r.FIELD_UNRECOGNIZED},a++);if(0!==n.missing_count&&(i.missing=n.missing_keys,t=!0),0!==n.invalid_count&&(i.invalid=n.invalid_keys,t=!0),0!==a&&(i.unrecognized=o,t=!0),t){if(i.error_message="One or more errors.",i.error=r.ONE_OR_MORE_ERRORS,0===n.errors.length)return i;n.errors.push(i)}return 0!==n.errors.length?1===n.errors.length?n.errors[0]:{error:r.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:n.errors}:void 0},r.prototype.end=function(r){var e=this;return r?(e.end_callback=r,void(e.async_waiting<=0&&r(e.generate_response(),e.recognized_keys))):e.generate_response()},r.prototype.end_with_recognized=function(r){var e=this;if(r)e.end(r);else if(e.async_waiting>0)return[e.generate_response(),e.recognized_keys]},r.ASYNC=-1,r.REQUIRED_ERROR=Math.sqrt,r.NOT_REQUIRED_BUT_MISSING=Math.floor,r.ONE_OR_MORE_ERRORS=0,r.FIELD_MISSING=1,r.INCORRECT_FIELD_TYPE=2,r.FIELD_UNRECOGNIZED=3,r.MULTIPLE_ERRORS=4,r.INCORRECT_TYPE_ERROR=function(e,n){return{error_message:"Incorrect field type. Expected "+e+".",error:r.INCORRECT_FIELD_TYPE,expected:e,received:n}},r.MISSING_ERROR=function(){return{error_message:"Field missing.",error:r.FIELD_MISSING}},r.get_value_and_type=function(r,e,n){n||(n={});var i=void 0!==n.parse?n.parse:!1;if("string"!=typeof r||i)if("integer"===e){var t=parseInt(r,10);isNaN(t)||t.toString().length!==r.toString().length||(r=t,e=t,e="number")}else if("float"===e||"number"===e){var o=parseFloat(r,10);isNaN(o)||o.toString().length!==r.toString().length||(r=o,e="number")}var a=typeof r;return"object"===a&&Array.isArray(r)&&(a="array"),{type:a,desired_type:e,value:r}},r.use_check=function(e,n,i){var t,o=!0,a={},s=0;if("object"==typeof e){if(Array.isArray(e)){var u=!1,c=e,_=!1,d=function(){if(s++,n.stop||s>c.length)return _=!0,void i();var e=r.use_check(c[s-1],n,function(){d()});e===r.ASYNC&&(u=!0)};return d(),_?u?r.ASYNC:void 0:r.ASYNC}a=e,t=a.check,a&&void 0!==a.stop_on_error&&(o=a.stop_on_error)}else{if("function"!=typeof e)throw new Error("A check can only be provided as a function or as an object with a function as the .check property.");t=e,o=!0}var l=function(e){if(null!==e&&void 0!==e){if(o&&(n.stop=!0),n.had_error=!0,e===r.REQUIRED_ERROR)return n.field_name?(n.validator.missing(n.field_name,a),void i()):n.existing_validator?(n.validator.error(r.create_error(r.MISSING_ERROR,a)),void i()):(n.return_missing=!0,void i());e===r.NOT_REQUIRED_BUT_MISSING?i():n.existing_validator?(n.field_name?n.validator.invalid(n.field_name,e):n.validator.error(e),i()):(n.validator.error(e),i())}else i()},v=t(n.value,n.emit,function(r){l(r)});return 3===t.length?r.ASYNC:(l(v),null)},r.use_checks=function(e,n,i,t){"function"==typeof i&&(t=i,i=void 0),i||(i={});var o={value:e,field_name:i.field_name,emit:function(r){o.value=r},options:i,stop:!1,return_missing:!1,had_error:!1};i.validator?(o.validator=i.validator,o.existing_validator=!0):o.validator=new r;var a,s=!1,u=function(r){a=r,s=!0,t&&t(r)};o.validator.async_waiting++;var c=r.use_check(n||[],o,function(){return o.had_error?o.options.emit&&o.options.emit(void 0):o.options.emit&&o.options.emit(o.value),o.return_missing?(u(r.REQUIRED_ERROR),void o.validator.async_call_ended()):o.existing_validator?(u(void 0),void o.validator.async_call_ended()):(u(o.validator.end()),void o.validator.async_call_ended())});return c===r.ASYNC?(t&&(u=t),r.ASYNC):s?a:r.ASYNC},r.required=function(e,n){var i=function(n){return null===n||void 0===n?e||void 0===e?r.REQUIRED_ERROR:r.NOT_REQUIRED_BUT_MISSING:void 0};return void 0!==n?(n.check=i,n):i},r.type=function(e,n){var i=n&&void 0!==n.required?n.required:!0,t=function(t,o){var a=r.required(i)(t);if(a)return a;var s=r.get_value_and_type(t,e,n),u=s.desired_type,c=s.type;return t=s.value,c!==u?r.create_error(r.INCORRECT_TYPE_ERROR,n,u,c):void(o&&o(t))};return void 0!==n?(n.check=t,n):t},r.create_error=function(e,n){if(!n)return e.apply(null,Array.prototype.slice.call(arguments,2));if(e===r.MISSING_ERROR){var i=typeof n.missing_error;if("function"===i)return n.missing_error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===i)return n.missing_error;if("string"===i)return{error_message:n.missing_error}}else{var t=typeof n.error;if("function"===t)return n.error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===t)return n.error;if("string"===t)return{error_message:n.error}}return e.apply(null,Array.prototype.slice.call(arguments,2))},r}.call();"undefined"!=typeof module&&(module.exports=FieldVal);