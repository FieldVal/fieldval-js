var FieldVal=function(){"use strict";function r(e,n){var i=this;if(i.async_waiting=0,i.validating=e,i.missing_keys={},i.invalid_keys={},i.unrecognized_keys={},i.recognized_keys={},i.errors=[],void 0!==n)if(n){var t;if(n.error===r.ONE_OR_MORE_ERRORS)t=n;else if(n.error===r.MULTIPLE_ERRORS)for(var o=0;o<n.errors.length;o++){var a=n.errors[o];0!==a.error?i.errors.push(a):t=a}else i.errors.push(n);if(t){for(var s in e)e.hasOwnProperty(s)&&(i.recognized_keys[s]=!0);if(t.missing&&(i.missing_keys=t.missing),t.unrecognized){i.unrecognized_keys=t.unrecognized;for(var _ in i.unrecognized_keys)i.unrecognized_keys.hasOwnProperty(_)&&delete i.recognized_keys[_]}t.invalid&&(i.invalid_keys=t.invalid)}}else for(var s in e)e.hasOwnProperty(s)&&(i.recognized_keys[s]=!0)}Array.isArray||(Array.isArray=function(r){return"[object Array]"===Object.prototype.toString.call(r)});var e=function(r){var e;for(e in r)if(r.hasOwnProperty(e))return!1;return!0};return r.prototype.dig=function(){var e,n=this,i=arguments[0];e=Array.isArray(i)?i:arguments;for(var t=n.validating,o=n,a=0;a<e.length;a++){var s=e[a];if(t=t[s],void 0===t)return void 0;if(o){var _;_=o instanceof r?o.invalid_keys:o.invalid,_&&(o=_[s])}}return new r(t,o)},r.prototype.invalid=function(){var e,n,i=this,t=arguments[arguments.length-1];if(2===arguments.length){var o=arguments[0];if(!Array.isArray(o))return i.invalid_keys[arguments[0]]=r.add_to_invalid(t,i.invalid_keys[arguments[0]]),i;e=o,n=o.length}else e=arguments,n=arguments.length-1;for(var a=i,s=0;n>s;s++){var _,u=e[s];_=a instanceof r?a.invalid_keys:a.invalid;var d;d=s===n-1?t:_[u],d||(d={error:r.ONE_OR_MORE_ERRORS,error_message:r.ONE_OR_MORE_ERRORS_STRING,invalid:{}}),a instanceof r?a.invalid(u,d):_[u]=r.add_to_invalid(d,_[u]),a=d}return i},r.prototype.default_value=function(r){var e=this;return{get:function(){var n=e.get.apply(e,arguments);return void 0!==n?n:r}}},r.prototype.get=function(e){var n,i=this,t=Array.prototype.slice.call(arguments,1),o=!1,a=i.get_async(e,t,function(r){o=!0,n=r});if(a===r.ASYNC)throw new Error(".get used with async checks, use .get_async.");return n},r.prototype.get_async=function(e,n,i){var t=this;if(!Array.isArray(n))throw new Error(".get_async second argument must be an array of checks");var o=t.validating[e];t.recognized_keys[e]=!0;var a=r.use_checks(o,n,{validator:t,field_name:e,emit:function(r){o=r}},function(){void 0!==i&&i(o)});return a===r.ASYNC?r.ASYNC:void 0},r.prototype.error=function(r){var e=this;return e.errors.push(r),e},r.add_to_invalid=function(e,n){if(void 0!==n){if(void 0!==n.errors){for(var i=0;i<n.errors.length;i++){var t=n.errors;void 0!==t.error&&t.error===e.error&&(n.errors[i]=e)}n.errors.push(e)}else n=void 0!==n.error&&n.error===e.error?e:{error:r.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:[n,e]};return n}return e},r.prototype.missing=function(e,n){var i=this;return i.missing_keys[e]=r.create_error(r.MISSING_ERROR,n),i},r.prototype.unrecognized=function(e){var n=this;return n.unrecognized_keys[e]={error_message:"Unrecognized field.",error:r.FIELD_UNRECOGNIZED},n},r.prototype.recognized=function(r){var e=this;return e.recognized_keys[r]=!0,e},r.prototype.get_unrecognized=function(){var r,e=this,n=[];for(r in e.validating)e.validating.hasOwnProperty(r)&&e.recognized_keys[r]!==!0&&n.push(r);return n},r.prototype.async_call_ended=function(){var r=this;r.async_waiting--,r.async_waiting<=0&&r.end_callback&&r.end_callback(r.generate_response(),r.recognized_keys)},r.prototype.generate_response=function(){var n,i=this,t={},o=!1,a={};for(n in i.unrecognized_keys)i.unrecognized_keys.hasOwnProperty(n)&&(a[n]=i.unrecognized_keys[n]);var s,_,u=i.get_unrecognized();for(s=0;s<u.length;s++)_=u[s],a[_]||(a[_]={error_message:"Unrecognized field.",error:r.FIELD_UNRECOGNIZED});if(e(i.missing_keys)||(t.missing=i.missing_keys,o=!0),e(i.invalid_keys)||(t.invalid=i.invalid_keys,o=!0),e(a)||(t.unrecognized=a,o=!0),o){if(t.error_message=r.ONE_OR_MORE_ERRORS_STRING,t.error=r.ONE_OR_MORE_ERRORS,0===i.errors.length)return t;i.errors.push(t)}return 0!==i.errors.length?1===i.errors.length?i.errors[0]:{error:r.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:i.errors}:null},r.prototype.end=function(r){var e=this;return r?(e.end_callback=r,void(e.async_waiting<=0&&r(e.generate_response(),e.recognized_keys))):e.generate_response()},r.prototype.end_with_recognized=function(r){var e=this;if(r)e.end(r);else if(e.async_waiting>0)return[e.generate_response(),e.recognized_keys]},r.ASYNC=-1,r.REQUIRED_ERROR=Math.sqrt,r.NOT_REQUIRED_BUT_MISSING=Math.floor,r.ONE_OR_MORE_ERRORS=0,r.ONE_OR_MORE_ERRORS_STRING="One or more errors.",r.FIELD_MISSING=1,r.INCORRECT_FIELD_TYPE=2,r.FIELD_UNRECOGNIZED=3,r.MULTIPLE_ERRORS=4,r.INCORRECT_TYPE_ERROR=function(e,n){return{error_message:"Incorrect field type. Expected "+e+".",error:r.INCORRECT_FIELD_TYPE,expected:e,received:n}},r.MISSING_ERROR=function(){return{error_message:"Field missing.",error:r.FIELD_MISSING}},r.get_value_and_type=function(r,e,n){n||(n={});var i=void 0!==n.parse?n.parse:!1;if("string"!=typeof r||i)if("integer"===e){var t=parseInt(r,10);isNaN(t)||t.toString().length!==r.toString().length||(r=t,e=t,e="number")}else if("float"===e||"number"===e){var o=parseFloat(r,10);isNaN(o)||o.toString().length!==r.toString().length||(r=o,e="number")}var a=typeof r;return"object"===a&&Array.isArray(r)&&(a="array"),{type:a,desired_type:e,value:r}},r.use_check=function(e,n,i){var t,o=!0,a={},s=0;if("object"==typeof e){if(Array.isArray(e)){var _=!1,u=e,d=!1,l=function(){if(s++,n.stop||s>u.length)return d=!0,void i();var e=r.use_check(u[s-1],n,function(){l()});e===r.ASYNC&&(_=!0)};return l(),d?_?r.ASYNC:void 0:r.ASYNC}a=e,t=a.check,a&&void 0!==a.stop_on_error&&(o=a.stop_on_error)}else{if("function"!=typeof e)throw new Error("A check can only be provided as a function or as an object with a function as the .check property.");t=e,o=!0}var c=function(e){if(null!==e&&void 0!==e){if(o&&(n.stop=!0),n.had_error=!0,e===r.REQUIRED_ERROR)return void 0!==n.field_name?(n.validator.missing(n.field_name,a),void i()):n.existing_validator?(n.validator.error(r.create_error(r.MISSING_ERROR,a)),void i()):(n.return_missing=!0,void i());e===r.NOT_REQUIRED_BUT_MISSING?i():n.existing_validator?(n.field_name?n.validator.invalid(n.field_name,e):n.validator.error(e),i()):(n.validator.error(e),i())}else i()},v=t(n.value,n.emit,function(r){c(r)});return 3===t.length?r.ASYNC:(c(v),null)},r.use_checks=function(e,n,i,t){"function"==typeof i&&(t=i,i=void 0),i||(i={});var o={value:e,field_name:i.field_name,emit:function(r){o.value=r},options:i,stop:!1,return_missing:!1,had_error:!1};i.validator?(o.validator=i.validator,o.existing_validator=!0):o.validator=new r;var a,s=!1,_=function(r){a=r,s=!0,t&&t(r)};o.validator.async_waiting++;var u=r.use_check(n||[],o,function(){return o.had_error?o.options.emit&&o.options.emit(void 0):o.options.emit&&o.options.emit(o.value),o.return_missing?(_(r.REQUIRED_ERROR),void o.validator.async_call_ended()):o.existing_validator?(_(null),void o.validator.async_call_ended()):(_(o.validator.end()),void o.validator.async_call_ended())});return u===r.ASYNC?(t&&(_=t),r.ASYNC):s?a:r.ASYNC},r.required=function(e,n){var i=function(n){return null===n||void 0===n?e||void 0===e?r.REQUIRED_ERROR:r.NOT_REQUIRED_BUT_MISSING:void 0};return void 0!==n?(n.check=i,n):i},r.type=function(e,n){var i=n&&void 0!==n.required?n.required:!0,t=function(t,o){var a=r.required(i)(t);if(a)return a;var s=r.get_value_and_type(t,e,n),_=s.desired_type,u=s.type;return t=s.value,u!==_?r.create_error(r.INCORRECT_TYPE_ERROR,n,_,u):void(o&&o(t))};return void 0!==n?(n.check=t,n):t},r.create_error=function(e,n){if(!n)return e.apply(null,Array.prototype.slice.call(arguments,2));if(e===r.MISSING_ERROR){var i=typeof n.missing_error;if("function"===i)return n.missing_error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===i)return n.missing_error;if("string"===i)return{error_message:n.missing_error}}else{var t=typeof n.error;if("function"===t)return n.error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===t)return n.error;if("string"===t)return{error_message:n.error}}return e.apply(null,Array.prototype.slice.call(arguments,2))},r}.call();"undefined"!=typeof module&&(module.exports=FieldVal);